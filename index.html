<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Data & Progress Tracker with Google Drive Sync</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4 flex items-center justify-between">
    <h1 class="text-2xl font-semibold text-gray-800">Customer Progress Tracker</h1>
    <div class="flex items-center gap-4">
      <button
        id="addCustomerBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2"
        aria-label="Add new customer"
      >
        <i class="fas fa-user-plus"></i> Add Customer
      </button>
      <button
        id="signInBtn"
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center gap-2"
        aria-label="Sign in with Google"
      >
        <i class="fab fa-google"></i> Sign In
      </button>
      <button
        id="signOutBtn"
        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center gap-2 hidden"
        aria-label="Sign out"
      >
        <i class="fas fa-sign-out-alt"></i> Sign Out
      </button>
    </div>
  </header>

  <main class="flex-grow container mx-auto p-4 max-w-7xl">
    <section class="overflow-x-auto">
      <table class="min-w-full bg-white rounded shadow overflow-hidden">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th class="text-left px-4 py-3 w-1/12">#</th>
            <th class="text-left px-4 py-3 w-2/12">Name</th>
            <th class="text-left px-4 py-3 w-2/12">Email</th>
            <th class="text-left px-4 py-3 w-2/12">Phone</th>
            <th class="text-left px-4 py-3 w-3/12">Progress Details</th>
            <th class="text-center px-4 py-3 w-2/12">Actions</th>
          </tr>
        </thead>
        <tbody id="customerTableBody" class="divide-y divide-gray-200">
        </tbody>
      </table>
    </section>
  </main>

  <div
    id="modalBackdrop"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    aria-hidden="true"
  >
    <div
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
      class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4"
    >
      <form id="customerForm" class="p-6 flex flex-col gap-4" novalidate>
        <h2 id="modalTitle" class="text-xl font-semibold text-gray-800">Add Customer</h2>

        <label class="flex flex-col">
          <span class="font-medium text-gray-700">Full Name <span class="text-red-600">*</span></span>
          <input
            type="text"
            id="nameInput"
            name="name"
            required
            class="mt-1 p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="John Doe"
            autocomplete="off"
          />
          <span class="text-red-600 text-sm mt-1 hidden" id="nameError">Name is required.</span>
        </label>

        <label class="flex flex-col">
          <span class="font-medium text-gray-700">Email <span class="text-red-600">*</span></span>
          <input
            type="email"
            id="emailInput"
            name="email"
            required
            class="mt-1 p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="john@example.com"
            autocomplete="off"
          />
          <span class="text-red-600 text-sm mt-1 hidden" id="emailError">Valid email is required.</span>
        </label>

        <label class="flex flex-col">
          <span class="font-medium text-gray-700">Phone Number</span>
          <input
            type="tel"
            id="phoneInput"
            name="phone"
            class="mt-1 p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="+1 555 123 4567"
            autocomplete="off"
          />
        </label>

        <label class="flex flex-col">
          <span class="font-medium text-gray-700">Progress Details</span>
          <textarea
            id="progressInput"
            name="progress"
            rows="4"
            class="mt-1 p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
            placeholder="Enter progress details here..."
          ></textarea>
        </label>

        <div class="flex justify-end gap-3 pt-2">
          <button
            type="button"
            id="cancelBtn"
            class="px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="saveBtn"
            class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    // Replace with your Google OAuth 2.0 Client ID from Google Cloud Console
    const CLIENT_ID = 'YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    const addCustomerBtn = document.getElementById('addCustomerBtn');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const customerForm = document.getElementById('customerForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const customerTableBody = document.getElementById('customerTableBody');

    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const phoneInput = document.getElementById('phoneInput');
    const progressInput = document.getElementById('progressInput');

    const nameError = document.getElementById('nameError');
    const emailError = document.getElementById('emailError');

    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');

    let customers = [];
    let editingCustomerId = null;

    let tokenClient;
    let accessToken = null;
    let fileId = null;

    // Debounce utility
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Initialize Google Identity Services token client
    function initializeGsi() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: '',
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            alert('Google Authentication Error: ' + tokenResponse.error);
            return;
          }
          accessToken = tokenResponse.access_token;
          signInBtn.classList.add('hidden');
          signOutBtn.classList.remove('hidden');
          loadDataFromDrive();
        },
      });
    }

    // Sign in button click
    signInBtn.addEventListener('click', () => {
      if (!tokenClient) {
        alert('Google API not initialized yet.');
        return;
      }
      // Request access token with consent prompt to avoid blocked access
      tokenClient.requestAccessToken({ prompt: 'consent' });
    });

    // Sign out button click
    signOutBtn.addEventListener('click', () => {
      accessToken = null;
      fileId = null;
      customers = [];
      renderCustomers();
      signInBtn.classList.remove('hidden');
      signOutBtn.classList.add('hidden');
      alert('Signed out. Your data is no longer synced.');
    });

    // Validate form inputs
    function validateForm() {
      let valid = true;

      if (!nameInput.value.trim()) {
        nameError.classList.remove('hidden');
        valid = false;
      } else {
        nameError.classList.add('hidden');
      }

      if (!emailInput.value.trim() || !emailInput.checkValidity()) {
        emailError.classList.remove('hidden');
        valid = false;
      } else {
        emailError.classList.add('hidden');
      }

      return valid;
    }

    // Save or update customer
    function saveCustomer() {
      if (!validateForm()) return false;

      const newCustomer = {
        id: editingCustomerId || crypto.randomUUID(),
        name: nameInput.value.trim(),
        email: emailInput.value.trim(),
        phone: phoneInput.value.trim(),
        progress: progressInput.value.trim(),
      };

      if (editingCustomerId) {
        customers = customers.map((c) => (c.id === editingCustomerId ? newCustomer : c));
      } else {
        customers.push(newCustomer);
      }

      saveData();
      renderCustomers();
      closeModal();
      return true;
    }

    // Render customers table
    function renderCustomers() {
      customerTableBody.innerHTML = '';
      if (customers.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'text-center py-6 text-gray-500';
        td.textContent = 'No customers added yet.';
        tr.appendChild(td);
        customerTableBody.appendChild(tr);
        return;
      }

      customers.forEach((customer, index) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        const tdIndex = document.createElement('td');
        tdIndex.className = 'px-4 py-3 whitespace-nowrap text-gray-700';
        tdIndex.textContent = index + 1;
        tr.appendChild(tdIndex);

        const tdName = document.createElement('td');
        tdName.className = 'px-4 py-3 whitespace-nowrap text-gray-900 font-medium';
        tdName.textContent = customer.name;
        tr.appendChild(tdName);

        const tdEmail = document.createElement('td');
        tdEmail.className = 'px-4 py-3 whitespace-nowrap text-gray-700';
        tdEmail.textContent = customer.email;
        tr.appendChild(tdEmail);

        const tdPhone = document.createElement('td');
        tdPhone.className = 'px-4 py-3 whitespace-nowrap text-gray-700';
        tdPhone.textContent = customer.phone || '-';
        tr.appendChild(tdPhone);

        const tdProgress = document.createElement('td');
        tdProgress.className = 'px-4 py-3 whitespace-pre-wrap text-gray-700 max-w-xs';
        tdProgress.textContent = customer.progress || '-';
        tr.appendChild(tdProgress);

        const tdActions = document.createElement('td');
        tdActions.className = 'px-4 py-3 whitespace-nowrap text-center flex justify-center gap-3';

        const editBtn = document.createElement('button');
        editBtn.className =
          'text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded';
        editBtn.setAttribute('aria-label', `Edit customer ${customer.name}`);
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.addEventListener('click', () => openEditModal(customer.id));
        tdActions.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className =
          'text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 rounded';
        deleteBtn.setAttribute('aria-label', `Delete customer ${customer.name}`);
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteBtn.addEventListener('click', () => deleteCustomer(customer.id));
        tdActions.appendChild(deleteBtn);

        tr.appendChild(tdActions);

        customerTableBody.appendChild(tr);
      });
    }

    // Open modal for adding new customer
    function openAddModal() {
      editingCustomerId = null;
      customerForm.reset();
      nameError.classList.add('hidden');
      emailError.classList.add('hidden');
      modalBackdrop.classList.remove('hidden');
      nameInput.focus();
      document.getElementById('modalTitle').textContent = 'Add Customer';
    }

    // Open modal for editing existing customer
    function openEditModal(id) {
      const customer = customers.find((c) => c.id === id);
      if (!customer) return;
      editingCustomerId = id;
      nameInput.value = customer.name;
      emailInput.value = customer.email;
      phoneInput.value = customer.phone || '';
      progressInput.value = customer.progress || '';
      nameError.classList.add('hidden');
      emailError.classList.add('hidden');
      modalBackdrop.classList.remove('hidden');
      nameInput.focus();
      document.getElementById('modalTitle').textContent = 'Edit Customer';
    }

    // Close modal
    function closeModal() {
      modalBackdrop.classList.add('hidden');
      editingCustomerId = null;
    }

    // Delete customer by id
    function deleteCustomer(id) {
      if (confirm('Are you sure you want to delete this customer?')) {
        customers = customers.filter((c) => c.id !== id);
        saveData();
        renderCustomers();
      }
    }

    // Auto-save progress details in modal (real-time)
    const autoSaveProgress = debounce(() => {
      if (!editingCustomerId) return;

      const idx = customers.findIndex((c) => c.id === editingCustomerId);
      if (idx === -1) return;

      customers[idx].progress = progressInput.value;
      saveData();
      renderCustomers();
    }, 500);

    // Event listeners
    addCustomerBtn.addEventListener('click', openAddModal);

    cancelBtn.addEventListener('click', (e) => {
      e.preventDefault();
      closeModal();
    });

    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) {
        closeModal();
      }
    });

    customerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      saveCustomer();
    });

    progressInput.addEventListener('input', () => {
      autoSaveProgress();
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalBackdrop.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Google Drive API helpers

    async function findDataFile() {
      const response = await fetch(
        'https://www.googleapis.com/drive/v3/files?q=name=\'customer_data.json\' and trashed=false and mimeType=\'application/json\'&fields=files(id,name)',
        {
          headers: {
            Authorization: 'Bearer ' + accessToken,
          },
        }
      );
      if (!response.ok) throw new Error('Failed to search files');
      const data = await response.json();
      if (data.files && data.files.length > 0) {
        return data.files[0].id;
      }
      return null;
    }

    async function createDataFile(content) {
      const metadata = {
        name: 'customer_data.json',
        mimeType: 'application/json',
      };

      const boundary = '-------314159265358979323846';
      const delimiter = "\r\n--" + boundary + "\r\n";
      const close_delim = "\r\n--" + boundary + "--";

      const multipartRequestBody =
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        content +
        close_delim;

      const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: {
          Authorization: 'Bearer ' + accessToken,
          'Content-Type': 'multipart/related; boundary=' + boundary,
        },
        body: multipartRequestBody,
      });

      if (!response.ok) throw new Error('Failed to create file');
      const data = await response.json();
      return data.id;
    }

    async function updateDataFile(fileId, content) {
      const response = await fetch(
        `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
        {
          method: 'PATCH',
          headers: {
            Authorization: 'Bearer ' + accessToken,
            'Content-Type': 'application/json',
          },
          body: content,
        }
      );
      if (!response.ok) throw new Error('Failed to update file');
      return await response.json();
    }

    async function loadDataFromDrive() {
      try {
        fileId = await findDataFile();
        if (!fileId) {
          fileId = await createDataFile('[]');
          customers = [];
          renderCustomers();
          return;
        }
        const response = await fetch(
          `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
          {
            headers: {
              Authorization: 'Bearer ' + accessToken,
            },
          }
        );
        if (!response.ok) throw new Error('Failed to load data file');
        const text = await response.text();
        customers = JSON.parse(text);
        renderCustomers();
      } catch (error) {
        alert('Error loading data from Google Drive: ' + error.message);
        customers = [];
        renderCustomers();
      }
    }

    async function saveData() {
      if (!accessToken) {
        localStorage.setItem('customers', JSON.stringify(customers));
        return;
      }
      try {
        if (!fileId) {
          fileId = await createDataFile(JSON.stringify(customers));
        } else {
          await updateDataFile(fileId, JSON.stringify(customers));
        }
      } catch (error) {
        alert('Error saving data to Google Drive: ' + error.message);
      }
    }

    function loadLocalData() {
      const data = localStorage.getItem('customers');
      if (data) {
        try {
          customers = JSON.parse(data);
        } catch {
          customers = [];
        }
      } else {
        customers = [];
      }
      renderCustomers();
    }

    window.onload = () => {
      if (window.google && google.accounts && google.accounts.oauth2) {
        initializeGsi();
      } else {
        setTimeout(() => {
          if (window.google && google.accounts && google.accounts.oauth2) {
            initializeGsi();
          }
        }, 1000);
      }
      loadLocalData();
    };
  </script>
</body>
</html>